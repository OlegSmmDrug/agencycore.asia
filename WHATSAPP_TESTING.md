# Инструкция по тестированию WhatsApp

## Что было исправлено:

1. ✅ Включен Realtime для таблицы `whatsapp_messages` - сообщения будут появляться мгновенно
2. ✅ Обновлен webhook с детальным логированием
3. ✅ Добавлена нормализация номеров телефонов (разные форматы автоматически сопоставляются)
4. ✅ Webhook развернут и готов принимать сообщения

## Проверка настроек Wazzup:

### 1. Настройте webhook в панели Wazzup

URL для webhook:
```
https://wguiuqbmhadezqtscpnu.supabase.co/functions/v1/wazzup-webhook
```

### 2. Проверьте, что API ключ обновлен

Новый ключ: `73a288ffe6644b039c05d19dff14c124`

### 3. Тестирование

#### Шаг 1: Проверьте существующих клиентов
У вас в CRM есть клиенты с номерами:
- 77073282438 (Олежа, Барс)
- +7 (707) 328-24-83 (Тест Барс)
- +7 776 453 3418 (Дмитрий)

#### Шаг 2: Отправьте тестовое сообщение
Отправьте WhatsApp сообщение на номер вашего канала с любого из этих номеров.

#### Шаг 3: Проверьте логи
Webhook теперь выводит подробные логи:
- Какой номер ищется
- Сколько клиентов найдено
- Сопоставление номеров
- Результат сохранения

Логи можно посмотреть в Supabase Dashboard → Edge Functions → wazzup-webhook → Logs

#### Шаг 4: Проверьте UI
1. Откройте вкладку "WhatsApp" в системе
2. Сообщение должно появиться автоматически (realtime)
3. Чат должен отобразиться в списке чатов

## Возможные проблемы:

### Проблема: Сообщения не появляются

**Решение 1: Проверьте формат номера**
Webhook нормализует номера, но проверьте, что в CRM номер клиента записан правильно:
- ✅ Правильно: `77073282438`, `+7 (707) 328-24-38`, `8 707 328 24 38`
- ❌ Неправильно: `хз`, `77073282438 (дополнительный текст)`

**Решение 2: Проверьте webhook в Wazzup**
- URL должен быть точно таким: `https://wguiuqbmhadezqtscpnu.supabase.co/functions/v1/wazzup-webhook`
- Должны быть включены события: messages, statuses

**Решение 3: Проверьте логи webhook**
В Supabase Dashboard посмотрите логи edge function. Там будет видно:
- Приходят ли запросы от Wazzup
- Какие номера ищутся
- Найден ли клиент
- Есть ли ошибки при сохранении

### Проблема: Клиент не найден

Webhook будет искать клиента по нормализованному номеру телефона. Если в логах пишет "No client found", то:

1. Проверьте, что клиент существует в CRM
2. Убедитесь, что номер телефона клиента содержит цифры
3. Формат не важен - webhook автоматически нормализует

## Проверка работы в консоли

Откройте консоль браузера и проверьте:

```javascript
// Должна быть подписка на realtime
console.log('Checking Supabase realtime...')
```

Если сообщения не приходят в UI, но есть в базе данных - проблема в realtime подписке.

## Следующие шаги:

После того, как первое сообщение успешно придет:
1. Все новые сообщения будут автоматически появляться в UI
2. Можно отвечать прямо из системы
3. Realtime работает в обе стороны

## Отладка

Если ничего не работает, выполните SQL запрос в Supabase SQL Editor:

```sql
-- Проверьте, есть ли сообщения в базе
SELECT * FROM whatsapp_messages ORDER BY created_at DESC LIMIT 5;

-- Проверьте клиентов
SELECT id, name, phone FROM clients WHERE phone LIKE '%707%';
```

Если сообщения есть в базе, но не отображаются - проблема в UI/realtime.
Если сообщений нет - проблема в webhook/Wazzup.
